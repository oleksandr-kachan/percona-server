
call mtr.add_suppression("Failed to shutdown components infrastructure.");

SELECT audit_log_filter_set_filter('log_all', '{"filter": {"log": true}}');
SELECT audit_log_filter_set_user('%', 'log_all');

--let $log_path = `SELECT @@global.datadir`
--let $log_base_name = `SELECT @@global.audit_log_filter_file`

--source generate_audit_events.inc

# rotate log manually for it to properly close and have closing tags added
--move_file $log_path$log_base_name $log_path$log_base_name.1
SET GLOBAL audit_log_filter_flush = ON;

--let $json_file_path = $log_path
--let $json_file_name = $log_base_name.1
--source validate_json_file.inc

--echo #
--echo # Cleanup
DELETE FROM mysql.audit_log_user;
DELETE FROM mysql.audit_log_filter;
SELECT audit_log_filter_flush();

--remove_file $json_file_path$json_file_name
