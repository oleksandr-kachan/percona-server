#
# Test log_slow_replica_statements with row based replication
#
--source include/have_binlog_format_row.inc
--source include/master-slave.inc

SET SESSION binlog_rows_query_log_events=1;

CREATE TABLE t1 (id INT);
CREATE TABLE t2 (id INT);

DELIMITER |;
CREATE FUNCTION f1() RETURNS INTEGER
BEGIN
    INSERT INTO t2 VALUES (1),(2),(3);
    UPDATE t2 SET id=4 WHERE id=3;
    DELETE FROM t2;
    RETURN 1;
END|
DELIMITER ;|

--source include/sync_slave_sql_with_master.inc

--source include/log_prepare.inc

SET @saved_min_examined_row_limit=@@GLOBAL.min_examined_row_limit;
SET GLOBAL min_examined_row_limit=0;
SET @saved_long_query_time=@@GLOBAL.long_query_time;
SET GLOBAL long_query_time=0;
SET @saved_log_slow_replica_statements=@@GLOBAL.log_slow_replica_statements;
SET GLOBAL log_slow_replica_statements=OFF;
--source include/restart_slave_sql.inc

--let log_file=percona.slow_extended.log_slow_replica_statements_rbr
--source include/log_start.inc

#
# A statement that should not be slow-logged
#
--source include/rpl_connection_master.inc
INSERT INTO t1 VALUES (1);
--source include/sync_slave_sql_with_master.inc

#
# A statement that should be slow-logged
#
SET GLOBAL log_slow_replica_statements=ON;
--source include/rpl_connection_master.inc
# Explicit transaction to avoid slow-logging implicit BEGIN/COMMIT
BEGIN;
INSERT INTO t1 VALUES (2);
UPDATE t1 SET id = 3 WHERE id = 2;
DELETE FROM t1;
COMMIT;

SELECT f1();

--source include/sync_slave_sql_with_master.inc

#
# A statement that should not be slow-logged
#
SET GLOBAL log_slow_replica_statements=OFF;
--source include/rpl_connection_master.inc
INSERT INTO t1 VALUES (3);
--source include/sync_slave_sql_with_master.inc

--source include/log_stop.inc

--let grep_pattern= Write_rows `test`.`t1`
--source include/log_grep.inc
--let grep_pattern= Update_rows `test`.`t1`
--source include/log_grep.inc
--let grep_pattern= Delete_rows `test`.`t1`
--source include/log_grep.inc
--let grep_pattern= Write_rows `test`.`t2`
--source include/log_grep.inc
--let grep_pattern= Update_rows `test`.`t2`
--source include/log_grep.inc
--let grep_pattern= Delete_rows `test`.`t2`
--source include/log_grep.inc
--let grep_pattern= ^# User@Host: skip-grants user\[SQL_SLAVE\] @  \[\]
--source include/log_grep.inc

--source include/rpl_connection_master.inc
DROP FUNCTION f1;
DROP TABLE t1;
DROP TABLE t2;

--source include/rpl_connection_slave.inc
SET GLOBAL log_slow_replica_statements=@saved_log_slow_replica_statements;
SET GLOBAL long_query_time=@saved_long_query_time;
SET GLOBAL min_examined_row_limit=@saved_min_examined_row_limit;

--source include/log_cleanup.inc
--source include/rpl_end.inc
